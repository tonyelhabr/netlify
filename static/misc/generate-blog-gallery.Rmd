
```{r setup-1}
library(tidyverse)

rgx_ignore <- 'nba-rapm' # To ignore "draft" posts.
paths_post_raw <-
  fs::dir_ls(
    'content/post',
    regexp = '\\/index.md',
    recurse = TRUE
  ) %>% 
  str_subset('nba-rapm', negate = TRUE)
paths_post_raw
```

```{r rgx-1}
rgx_replace <- '(content\\/post\\/)(.*)(\\/)(.*)([.]png$)'
rgx_title <- '^title[:]\\s+'
rgx_date <- 'date[:]\\s+'
rgx_viz <- '(^[!][\\[][\\]].*)(viz.*png)(.*$)'
```


```{r debug1-1}
path_post <- 'content/post/analysis-texas-high-school-academics-1-intro/index.md'
# path_post <- 'content/post/nba-rapm-project-r-intro/index.md'
lines <- path_post %>% read_lines()
line_title <- lines %>% str_subset(rgx_title)
line_title %>% str_replace_all(rgx_title, '') %>% str_trim()
line_date <- lines %>% str_subset(rgx_date)
line_date %>% str_replace_all(rgx_date, '') %>% str_trim()
lines_viz <- lines %>% str_subset(rgx_viz)
lines_viz
```

```{r setup-1}
str_pluck <- function(x, pattern, replacement = '') {
  x %>% 
    str_subset(pattern) %>% 
    str_replace_all(pattern = pattern, replacement = replacement) %>% 
    str_trim()
}
str_pluck_title <- purrr::partial(str_pluck, pattern = rgx_title)
str_pluck_date <- purrr::partial(str_pluck, pattern = rgx_date)
str_pluck_viz <- purrr::partial(str_pluck, pattern = rgx_viz, replacement = '\\2')

paths_post <-
  paths_post_raw %>% 
  as.character() %>% 
  tibble(path_post = .) %>% 
  # filter(!fs::file_exists(path_viz)) %>% 
  mutate(
    lines = path_post %>% purrr::map(read_lines)
  ) %>% 
  mutate_at(vars(path_post), ~str_remove_all(., 'content|\\/index[.]md')) %>% 
  mutate_at(
    vars(lines),
    list(
      title = ~purrr::map_chr(., str_pluck_title),
      date = ~purrr::map_chr(., str_pluck_date),
      viz = ~purrr::map(., str_pluck_viz)
    )
  ) %>% 
  mutate_at(vars(date), lubridate::ymd) %>% 
  unnest(viz)
paths_post

paths_post_md <-
  paths_post %>% 
  mutate(
    # label_md = glue::glue('+ ![{viz}]({paste0(path_post, "/", viz)})') %>% as.character()
    label_md = sprintf('![%s](%s/%s)', viz, path_post, viz)
  ) %>% 
  select(title, date, path_post, label_md)
paths_post_md

content_gallery_raw <-
  paths_post_md %>%
  group_by(title, date, path_post) %>%
  do(add_row(., .before = 0)) %>% 
  ungroup() %>% 
  mutate_at(
    vars(label_md),
    ~case_when(
      # is.na(.) ~ sprintf('## [%s, %s](%s)', dplyr::lead(title), dplyr::lead(date), dplyr::lead(path_post)),
      is.na(.) ~ sprintf('## %s, [%s](%s)', dplyr::lead(date), dplyr::lead(title), dplyr::lead(path_post)),
      TRUE ~ .
    )
  ) %>% 
  fill(title, .direction = 'up') %>% 
  fill(date, .direction = 'up') %>% 
  arrange(date) %>% 
  mutate(idx_intragrp = dense_rank(sprintf('%s, %s', date, title))) %>%
  # mutate(idx_intragrp = dense_rank(label_md)) %>% 
  group_by(title, date) %>% 
  mutate(idx_intergrp = row_number()) %>% 
  ungroup() %>% 
  select(idx_intragrp, idx_intergrp, date, label_md) %>% 
  # arrange(desc(date))
  arrange(desc(idx_intragrp), idx_intergrp)
content_gallery_raw

content_gallery <-
  content_gallery_raw %>% 
  select(label_md) %>% 
  mutate(idx = row_number()) %>% 
  group_by(idx) %>% 
  do(add_row(., label_md = '', .before = 0)) %>% 
  ungroup() %>% 
  pull(label_md)
content_gallery

# Copy-paste this to the file for the gallery page.
content_gallery %>% clipr::write_clip()
```